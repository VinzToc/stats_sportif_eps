<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques - Bilan & Perspectives</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .player-info {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .player-name {
            font-weight: 700;
            font-size: 1.2em;
        }

        .observer-text {
            opacity: 0.9;
        }

        .observer-name {
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        .stats-summary {
            margin-bottom: 25px;
        }

        .section-title {
            color: #667eea;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .analysis-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .analysis-subtitle {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-content {
            color: #555;
            line-height: 1.6;
            font-size: 1em;
        }

        .strengths-box {
            border-left-color: #43e97b;
        }

        .strengths-box .analysis-subtitle {
            color: #43e97b;
        }

        .weaknesses-box {
            border-left-color: #f5576c;
        }

        .weaknesses-box .analysis-subtitle {
            color: #f5576c;
        }

        .footer-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: auto;
            transition: all 0.2s;
        }

        .footer-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
        }

        .footer-button:active {
            transform: translateY(0);
        }

        .icon {
            display: inline-block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 1.4em;
            }

            .player-info {
                font-size: 0.95em;
            }

            .section-title {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Analyse de pratique - Bilan & Perspectives pour le sportif observ√©</h1>
        </header>

        <div class="player-info">
            <span class="player-name" id="playerName">-</span>
            <span class="observer-text">observ√©(e) par</span>
            <span class="observer-name" id="observerName">-</span>
        </div>

        <div class="chart-container">
            <canvas id="radarChart"></canvas>
        </div>

        <div class="stats-summary">
            <h2 class="section-title">Bilan & perspectives</h2>
            
            <div class="analysis-box strengths-box">
                <div class="analysis-subtitle">
                    <span class="icon">‚úì</span>
                    <span>Actions observ√©es fr√©quemment</span>
                </div>
                <div class="analysis-content" id="strengthsText">
                    Analyse en cours...
                </div>
            </div>

            <div class="analysis-box weaknesses-box">
                <div class="analysis-subtitle">
                    <span class="icon">‚ö†</span>
                    <span>Actions peu observ√©es</span>
                </div>
                <div class="analysis-content" id="weaknessesText">
                    Analyse en cours...
                </div>
            </div>
        </div>

        <button class="footer-button" id="newAnalysisBtn">Nouvelle analyse ?</button>
    </div>

    <script>
        // R√©cup√©ration des donn√©es finales
        const finalData = JSON.parse(localStorage.getItem('observationFinalData'));

        if (!finalData) {
            alert('Erreur : Aucune donn√©e trouv√©e. Retour √† la page d\'accueil.');
            window.location.href = 'index.html';
        }

        // Affichage des informations du joueur et de l'observateur
        document.getElementById('playerName').textContent = finalData.joueur;
        document.getElementById('observerName').textContent = finalData.observateur;

        // Pr√©paration des donn√©es pour le graphique radar
        const labels = [];
        const data = [];
        const totalActions = [];

        for (let i = 1; i <= finalData.nbObservables; i++) {
            labels.push(finalData.items[i - 1]);
            const count = finalData.counts[`item${i}`] || 0;
            data.push(count);
            totalActions.push({ label: finalData.items[i - 1], count: count });
        }

        const totalCount = data.reduce((a, b) => a + b, 0);

        // Cr√©ation du graphique radar
        const ctx = document.getElementById('radarChart').getContext('2d');
        const radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Nombre d\'actions',
                    data: data,
                    backgroundColor: 'rgba(102, 126, 234, 0.2)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(102, 126, 234, 1)',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    r: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        pointLabels: {
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: `Analyse des ${totalCount} actions observ√©es`,
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        color: '#667eea'
                    }
                }
            }
        });

        // Analyse automatique des points forts et faibles
        function generateAnalysis() {
            // Tri des actions par nombre
            const sortedActions = [...totalActions].sort((a, b) => b.count - a.count);
            
            // Calcul de la moyenne
            const average = totalCount / finalData.nbObservables;
            
            // Points forts (au-dessus de la moyenne)
            const strengths = sortedActions.filter(action => action.count > average && action.count > 0);
            
            // Points faibles (en dessous de la moyenne)
            const weaknesses = sortedActions.filter(action => action.count < average || action.count === 0);

            // G√©n√©ration du texte des points forts
            let strengthsText = '';
            if (strengths.length > 0) {
                const topActions = strengths.slice(0, 3);
                strengthsText = `${finalData.joueur} se distingue particuli√®rement au travers des actions suivantes : `;
                strengthsText += topActions.map(a => `<strong>${a.label}</strong> (${a.count} fois)`).join(', ');
            } else {
                strengthsText = `Le joueur ${finalData.joueur} montre un profil √©quilibr√© sur l'ensemble des actions observ√©es.`;
            }

            // G√©n√©ration du texte des points √† travailler
            let weaknessesText = '';
            if (weaknesses.length > 0) {
                const bottomActions = weaknesses.filter(a => a.count === 0);
                const lowActions = weaknesses.filter(a => a.count > 0 && a.count < average);
                
                if (bottomActions.length > 0) {
                    weaknessesText += `Les actions suivantes n'ont pas √©t√© observ√©es : `;
                    weaknessesText += bottomActions.map(a => `<strong>${a.label}</strong>`).join(', ');
                    weaknessesText += `. `;
                }
                
                if (lowActions.length > 0) {
                    const focusActions = lowActions.slice(-3);
                    weaknessesText += `Ces actions ont √©t√© peu observ√©es : `;
                    weaknessesText += focusActions.map(a => `<strong>${a.label}</strong> (${a.count} fois seulement)`).join(', ');
                    weaknessesText += `.`;
                }
                
                weaknessesText += ` Cele r√©v√®le un profil de sportif, soit complet et √©quilibr√© si ces items √©taient n√©gatifs, soit cela montre les comp√©tences √† travailler dans le cas d'items positifs non observ√©s.`;
            } else {
                weaknessesText = `-`;
            }

            document.getElementById('strengthsText').innerHTML = strengthsText;
            document.getElementById('weaknessesText').innerHTML = weaknessesText;

            // Sauvegarde pour Google Sheets
            return {
                strengths: strengthsText.replace(/<\/?strong>/g, ''),
                weaknesses: weaknessesText.replace(/<\/?strong>/g, '')
            };
        }

        const analysis = generateAnalysis();

        // Pr√©paration des donn√©es pour Google Sheets
        function prepareSheetData() {
            const sheetData = {
                date: finalData.date,
                activite: finalData.activite,
                observateur: finalData.observateur,
                joueur: finalData.joueur,
                duree: finalData.duration,
                items: {},
                pointsForts: analysis.strengths,
                pointsFaibles: analysis.weaknesses
            };

            // Ajout des items et leurs compteurs
            for (let i = 1; i <= 12; i++) {
                if (i <= finalData.nbObservables) {
                    sheetData.items[`nom${i}`] = finalData.items[i - 1];
                    sheetData.items[`count${i}`] = finalData.counts[`item${i}`] || 0;
                } else {
                    sheetData.items[`nom${i}`] = '';
                    sheetData.items[`count${i}`] = '';
                }
            }

            return sheetData;
        }

        const sheetData = prepareSheetData();
        
        // Sauvegarde dans localStorage pour r√©f√©rence
        localStorage.setItem('lastSheetData', JSON.stringify(sheetData));

        // Fonction pour envoyer les donn√©es √† Google Sheets
        function sendToGoogleSheets() {
            // ‚ö†Ô∏è IMPORTANT: Remplacez cette URL par celle de votre Web App Google Apps Script
            const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw-yd75Dj14Lzfc4Z90ibxsVGOW9v-L3Oli0xXIU1f0h1_CXtriajMO-2EHg88vr3aM/exec';
            
            // V√©rification que l'URL a √©t√© configur√©e
            if (WEB_APP_URL === 'VOTRE_URL_WEB_APP_ICI') {
                console.warn('‚ö†Ô∏è URL du Web App non configur√©e. Les donn√©es ne seront pas envoy√©es √† Google Sheets.');
                console.log('üìã Donn√©es √† envoyer:', sheetData);
                return;
            }
            
            console.log('üì§ Envoi des donn√©es √† Google Sheets...');
            console.log('Donn√©es:', sheetData);
            
            // Cr√©ation d'un formulaire pour envoyer les donn√©es
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = WEB_APP_URL;
            form.target = 'hidden_iframe';
            form.style.display = 'none';
            
            // Ajout d'un champ avec les donn√©es JSON
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(sheetData);
            form.appendChild(input);
            
            // Cr√©ation d'une iframe cach√©e pour recevoir la r√©ponse
            let iframe = document.getElementById('hidden_iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'hidden_iframe';
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            // Ajout du formulaire au document et soumission
            document.body.appendChild(form);
            
            // Gestion de la r√©ponse
            iframe.onload = function() {
                console.log('‚úÖ Donn√©es envoy√©es √† Google Sheets avec succ√®s');
                setTimeout(function() {
                    document.body.removeChild(form);
                }, 1000);
            };
            
            // Envoi du formulaire
            form.submit();
            
            // Message de confirmation apr√®s un court d√©lai
            setTimeout(function() {
                console.log('‚úÖ Requ√™te envoy√©e. V√©rifiez votre Google Sheets.');
            }, 500);
        }

        // Envoi automatique des donn√©es
        sendToGoogleSheets();

        // Bouton Nouvelle analyse
        document.getElementById('newAnalysisBtn').addEventListener('click', function() {
            if (confirm('Commencer une nouvelle analyse ? Toutes les donn√©es actuelles seront r√©initialis√©es.')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        });

        // Log des donn√©es pour v√©rification
        console.log('Donn√©es pr√©par√©es pour Google Sheets:', sheetData);
    </script>
</body>
</html>